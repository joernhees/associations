<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
        content="GraphPatternLearner Association Prediction Demo">
  <meta name="author" content="Jörn Hees">

  <title>GraphPatternLearner Association Prediction Demo</title>

  <base href="../../" target="_blank">

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">

  <!-- Custom Fonts -->
  <link
    href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
    rel='stylesheet' type='text/css'>
  <link
    href='//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic'
    rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css"
        type="text/css">

  <!-- Plugin CSS -->
  <link rel="stylesheet" href="css/animate.min.css" type="text/css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/creative.css" type="text/css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <style>
    /* reset button group to bootstrap as it's overwritten by creative */
    .input-group .input-group-btn .btn {
      border: 1px solid transparent;
      border-radius: 4px;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
    #demoResults .btn {
      border: 1px solid transparent;
    }
    .input-group .input-group-btn .btn-default,
    #demoResults .btn-default {
      border-color: #ccc;
    }

    #header-wrapper {
      min-height: 1100px;
    }

    header .header-content .header-content-inner p {
      margin-top: 15px;
      margin-bottom: 15px;
    }

    #fusedPrediction {
      min-width: 600px;
    }

    #demoResults .tab-pane {
      min-height: 600px;
    }

    #demoResults .placeholder {
      min-height: 600px;
      height: 50vh;
      display: flex;
      align-items: center;
    }

    #graphPatternContent .panel-default {
      background-color: #f5f5f5;
    }
    #graphPatternContent h4 small {
      margin-left: 10px;
    }

    /* if filtered don't show not selected gps */
    #graphPatternContent.filtered a.list-group-item {
      display: none;
    }
    #graphPatternContent.filtered a.list-group-item.active {
      display: block;
    }


    /* highlight selected or current row buttons */
    #fusedPrediction table>tbody>tr>td button,
    #fusedPrediction table>tbody>tr:hover>td .selected>button {
      opacity: 0.2;
    }
    #fusedPrediction table>tbody>tr:hover>td button,
    #fusedPrediction table>tbody>tr>td button.selected,
    #fusedPrediction table>tbody>tr:hover>td> .selected>button.selected {
      opacity: 1.0;
    }
  </style>
</head>

<body id="page-top">

<nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://w3id.org/associations/#gp_learner">Associations</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a class="page-scroll" href="#demo">Prediction Demo</a>
        </li>
        <li>
          <a class="page-scroll" href="#moreInfo">Further Information</a>
        </li>
      </ul>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container-fluid -->
</nav>

<header class="bg-dark">
  <div id="header-wrapper">
    <div class="header-content">
      <div class="header-content-inner">
        <h1>Human Association Prediction Demo</h1>
        <hr>
        <p>
          This page demonstrates how <a href="https://en.wikipedia.org/wiki/Association_(psychology)">human associations</a> can be simulated with <a href="https://en.wikipedia.org/wiki/Linked_data">Linked Data</a>.
        </p>
        <p>
          For this demo, we used the <a href="https://w3id.org/associations/#gp_learner">Graph Pattern Learner</a> to train a machine learning model on a training <a href="https://w3id.org/associations/#datasets">dataset of human associations</a> (e.g., <a href="http://dbpedia.org/resource/Dog">Dog</a> - <a href="http://dbpedia.org/resource/Cat">Cat</a>).
        </p>
        <p>
          Click <a href="#demo" class="page-scroll">continue</a> to try the <i>trained model</i> out yourself by entering a <i>source</i> node and have it predict <i>target</i> nodes that humans are likely to associate.
        </p>
        <p><img style="width: 80%; min-width: 600px" src="gp_learner/demo/ml_outline_crop.png"></p>
        <a href="#demo" class="btn btn-primary btn-xl page-scroll">Continue</a>
      </div>
    </div>
  </div>
</header>

<section id="demo">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 text-center">
        <h2 class="section-heading">Demo</h2>
        <hr class="primary">
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-xs12">
        <div class="row">
          <div class="col-sm-offset-1 col-sm-10">
            <form id="stimulusForm" class="form">
              <div class="form-group">
                <label>Enter a stimulus:</label>
                <div class="input-group">
                  <input class="form-control autocomplete"
                         type="text"
                         autocomplete="off"
                         placeholder="e.g., Dog, Cat, House, Horse"/>
                  <span class="input-group-btn">
                    <button type="submit" class="btn btn-default" data-loading-text="<i class='fa fa-spinner fa-spin fa-large'></i> predicting...">Submit</button>
                  </span>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-offset-1 col-sm-10">
            <div id="demoResults">
              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#graphPatterns" aria-controls="Graph Patterns" role="tab" data-toggle="tab">Graph Patterns <span id="gp-count" class="badge"><i class='fa fa-spinner fa-spin fa-large'></i></span></a></li>
                <li role="presentation" class="disabled"><a href="#fusedPrediction" aria-controls="fusedPrediction" role="tab" data-toggle="tab">Fused Prediction Results</a></li>
              </ul>

              <!-- Tab panes -->
              <div class="tab-content">

                <div role="tabpanel" class="tab-pane fade in active" id="graphPatterns">
                  <div class="placeholder jumbotron text-center">
                    <div class="col-xs-12">
                      <p>Loading...</p>
                      <p><i class='fa fa-spinner fa-spin fa-3x fa-fw'></i></p>
                    </div>
                  </div>
                  <div id="graphPatternContentPanel" class="hidden panel panel-default">
                    <div class="panel-heading">
                      <p>In this tab you can inspect the patterns used for prediction.</p>
                      <div class="btn-toolbar" role="toolbar" aria-label="Graph Pattern Controls">
                        <div class="btn-group" role="group" aria-label="SPARQL toggler">
                          <button type="button" class="btn btn-default disabled">SPARQL:</button>
                          <button id="btnAllSPARQLCollapse" type="button" class="btn btn-default"><i class="fa fa-compress" aria-hidden="true"></i></button>
                          <button id="btnAllSPARQLExpand" type="button" class="btn btn-default"><i class="fa fa-expand" aria-hidden="true"></i></button>
                        </div>
                        <div class="btn-group" role="group" aria-label="Target candidate toggler">
                          <button type="button" class="btn btn-default disabled">Targets:</button>
                          <button id="btnAllTargetsCollapse" type="button" class="btn btn-default"><i class="fa fa-compress" aria-hidden="true"></i></button>
                          <button id="btnAllTargetsExpand" type="button" class="btn btn-default"><i class="fa fa-expand" aria-hidden="true"></i></button>
                        </div>
                        <div class="btn-group" role="group" aria-label="Filter toggler">
                          <button type="button" class="btn btn-default disabled">Filter:</button>
                          <button id="btnFilterToggle" type="button" class="btn btn-default" autocomplete="off"><i class="fa fa-filter" aria-hidden="true"></i></button>
                          <button id="btnFilterForget" type="button" class="btn btn-default"><i class="fa fa-remove" aria-hidden="true"></i></button>
                        </div>
                      </div>
                    </div>
                    <div class="panel-body">
                      <div id="graphPatternContent" class="list-group"></div>
                    </div>
                  </div>
                </div>

                <div role="tabpanel" class="tab-pane fade" id="fusedPrediction">
                  <div class="placeholder jumbotron text-center">
                    <div class="col-xs-12">
                      <p>Predicting...</p>
                      <p style="font-size: small">(performing 100 SPARQL queries & fusing results)</p>
                      <p><i class='fa fa-spinner fa-spin fa-3x fa-fw'></i></p>
                    </div>
                  </div>
                  <table class="hidden table table-hover">
                    <thead><tr>
                      <th>#</th>
                      <th>Predicted response</th>
                      <th>Score</th>
                      <th>Explain</th>
                      <th>Feedback</th>
                    </tr></thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="moreInfo" class="bg-dark">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 text-center">
        <h2 class="section-heading">Want to find out more?</h2>
        <hr class="primary">
        <p>For more information make sure to visit the <a href="https://w3id.org/associations">main page</a>.</p>
        <p>Have a question, some idea, feedback or want to collaborate?</p>
        <p>Feel free to reach out:</p>
      </div>
    </div>
    <div class="row">
      <div class="col-md-4 text-center">
        <i class="fa fa-envelope-o fa-3x wow bounceIn"></i>
        <p><img src="./img/m.png"></p>
      </div>
      <div class="col-md-4 text-center">
        <i class="fa fa-user fa-3x wow bounceIn" data-wow-delay=".1s"></i>
        <p><a href="https://joernhees.de/blog/about" target="_blank">Jörn Hees</a><br>(main contact)</p>
      </div>
      <div class="col-md-4 text-center">
        <i class="fa fa-users fa-3x wow bounceIn" data-wow-delay=".2s"></i>
        <p><a href="https://km.dfki.de/" target="_blank">DFKI Knowledge Management</a><br>(our research group)</p>
      </div>
    </div>
  </div>
</section>


<!-- jQuery -->
<script src="js/jquery.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="js/jquery.easing.min.js"></script>
<script src="js/jquery.fittext.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/bootstrap3-typeahead.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="js/creative.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"
        charset="utf-8"></script>
<script>
    if (!window.d3) {
        console.warn("d3js.org not reachable");
        document.write('<script src="js/d3.min.js">\x3C/script>');
    }
</script>

<script src="gp_learner/demo/predict_config.js"></script>
<script>
    let demo_source = '';
    let graph_patterns = null;
    let gp_tcs = null;

    const $demo = $('#demoResults');
    const $graphPatterns = $demo.find('#graphPatterns');
    const $fusedPrediction = $demo.find('#fusedPrediction');
    const $stimulusForm = $('#stimulusForm');

    function load_graph_patterns() {
        $.get(
            gpl_endpoint_graph_patterns,
            null,
            function (data) {
                console.log('loaded gps', data);
                graph_patterns = data['graph_patterns'];
                render_graph_patterns();
            },
            'json'
        );
    }
    $(load_graph_patterns);

    function render_graph_patterns() {
        let $content = $graphPatterns.find('#graphPatternContent');
        for (let i=1; i <= graph_patterns.length; i++) {
            let gp = graph_patterns[i-1];
            // let $triples = $('<ul class="triples">');
            // for (let t of gp['graph_triples']) {
            //     let $t = $('<li class="triple">');
            //     for (let n of t) {
            //         $t.append($('<span class="node">').text(n).append(' '));
            //     }
            //     $t.append('.');
            //     $triples.append($t);
            // }
            let sparql = gp['sparql'].replace(/^PREFIX .*$\n/mg, '');

            let $sparql = $('<div class="collapse sparql" id="gpSparql'+ i +'">')
                .append($('<pre>').text(sparql));
            let $targets = $('<div class="collapse targets" id="gpTargets'+ i +'">')
                .append($('<div class="panel panel-default">')
                    .append($('<div class="panel-body">')
                        .append('<div>Targets predicted by this pattern for the given stimulus as <var>?source</var> node:</div><ul></ul>')));
            let $li = $('<a id="gp' + i + '" href="#" class="list-group-item">')
                .append('<h4 class="list-group-item-heading">GraphPattern ' + i +
                        ' <small><a data-toggle="collapse" href="#gpSparql'+ i +'">SPARQL <i class="fa fa-caret-down"></i></a></small>' +
                        ' <small><a data-toggle="collapse" href="#gpTargets'+ i +'">Targets <i class="fa fa-caret-down"></i></a></small>' +
                        '</h4>')
                //.append($triples)
                .append($sparql)
                .append($targets);
            $content.append($li);
        }
        $graphPatterns.find('.placeholder').addClass('hidden');
        $content.find('a.list-group-item').click(function (event) {
            event.preventDefault();
        });
        $('#btnAllSPARQLCollapse').click(function () {
            $content.find('.collapse.sparql').collapse('hide');
        });
        $('#btnAllSPARQLExpand').click(function () {
            $content.find('.collapse.sparql').collapse('show');
        });
        $('#btnAllTargetsCollapse').click(function () {
            $content.find('.collapse.targets').collapse('hide');
        });
        $('#btnAllTargetsExpand').click(function () {
            $content.find('.collapse.targets').collapse('show');
        });
        $('#graphPatternContentPanel').removeClass('hidden');
        unset_gp_highlights();
        $('#btnFilterToggle').click(toggleGPFilter);
        $('#btnFilterForget').click(unset_gp_highlights);

    }

    function render_targets_into_graph_patterns() {
        let $content = $('#graphPatternContent');
        for (let i=1; i <= gp_tcs.length; i++) {
            let tcs = gp_tcs[i-1];
            $ul = $content.find('#gp' + i + ' .targets ul');
            for (let target of tcs) {
                let starget = target.replace(/http:\/\/dbpedia.org\/resource\//, 'dbr:');
                $ul.append($('<li>').append($('<a>').attr('href', target).text(starget)));
            }
        }
    }

    function unset_gp_highlights() {
        $('#graphPatternContent a.list-group-item').removeClass('active');
        $('#gp-count').empty().append(graph_patterns.length);
        $('#graphPatternContent').removeClass('filtered');
        $('#btnFilterToggle').removeClass('active');
        $fusedPrediction.find('table .btn.filter.selected').removeClass('selected');
    }

    function explain (event) {
        unset_gp_highlights();
        let $btn = $(this);
        $btn.addClass('selected');
        let $row = $btn.parents('tr');
        let target = $row.find('td a.target').attr('href');
        let $sel_gps = $('#graphPatternContent .targets ul>li>a[href="' + target + '"]')
            .parents('a.list-group-item')
            .addClass('active');
        $('#gp-count').empty().append($sel_gps.length);
        toggleGPFilter();
        //$('#graphPatternContent').addClass('filtered');
    }

    function toggleGPFilter(event) {
        let state = $('#graphPatternContent').toggleClass('filtered').hasClass('filtered');
        let $btn = $('#btnFilterToggle');
        if (state) {
            $btn.addClass('active');
        } else {
            $btn.removeClass('active');
        }
    }

    function reset() {
        // resets the GUI
        demo_source = '';
        gp_tcs = null;

        // reset targets in graph patterns
        $('#graphPatternContent .collapse.targets ul').empty();
        unset_gp_highlights();

        // show placeholder, hide table
        $fusedPrediction.find('.placeholder').removeClass('hidden');
        $fusedPrediction.find('table').addClass('hidden');
    }

    function predict(source) {
        if (!source.startsWith('http://dbpedia.org/resource/')) {
            return;
        }
        let $input = $stimulusForm.find('input');
        $input.prop('disabled', true).val(source).text(source).blur();
        let $btn = $stimulusForm.find('button').button('loading');

        demo_source = source;
        $.post(
            gpl_endpoint_predict,
            {source: source},
            function (data) {
                console.log(data);
                gp_tcs = data['graph_pattern_target_candidates'];

                const $table = $fusedPrediction.find('table');
                const $tbody = $table.find('tbody');
                for (let fm of ['target_occs',]) {
                    $tbody.html('');
                    let res = data['fused_results'][fm];
                    console.log(res);
                    for (let i=0; i < Math.min(res.length, MAX_RESULT_ROWS); i++) {
                        let [target, score] = res[i];
                        console.log(target, score);
                        let starget = target.replace(/http:\/\/dbpedia.org\/resource\//, 'dbr:');
                        if (starget.length > 30) {
                            starget = starget.slice(0, 30) + '...';
                        }
                        $tbody.append(
                            '<tr>' +
                                '<td class="rank">' + (i+1) + '</td>' +
                                '<td><a class="target" href="' + target + '">' + starget + '</a></td>' +
                                '<td>' + score + '</td>' +
                                '<td><button class="btn btn-xs btn-info filter"><i class="fa fa-list" aria-hidden="true"></i></button></td>' +
                                '<td>' +
                                    '<div class="feedback btn-group" role="group">' +
                                        '<button class="btn btn-xs btn-success feedback-positive"><i class="fa fa-check" aria-hidden="true"></i></button>' +
                                        '<button class="btn btn-xs btn-warning feedback-negative"><i class="fa fa-times" aria-hidden="true"></i></button>' +
                                    '</div>' +
                                '</td>' +
                            '</tr>'
                        );
                    }
                    if (res.length > MAX_RESULT_ROWS) {
                        $tbody.append(
                            '<tr><td class="text-center" colspan="5">... ' + (res.length - MAX_RESULT_ROWS) + ' further results hidden to save your browser.</td></tr>'
                        );
                    }
                }
                $table.find('.feedback .btn').click(feedback);
                $table.find('.btn.filter').tooltip({
                    'placement': 'bottom',
                    'title': "Click here to highlight all patterns that predicted this target in the Graph Patterns tab."
                });
                $table.removeClass('hidden');
                $fusedPrediction.find('.placeholder').addClass('hidden');

                gp_tcs = data['graph_pattern_target_candidates'];
                render_targets_into_graph_patterns();
                $table.find('.btn.filter').click(explain);
            },
            'json'
        ).fail(function(jqXHR, textStatus, errorThrown) {
        }).always(function () {
            $input.prop('disabled', false);
            $btn.button('reset');
        });
    }

    function feedback(event) {
        let $btn = $(this);
        $btn.parent().addClass('selected').children().removeClass('selected');
        $btn.addClass('selected');
        let $row = $btn.parents('tr');
        let target = $row.find('td a.target').attr('href');
        let feedback = $btn.hasClass('feedback-positive');
        let rank = parseInt($row.find('td.rank').text());
        let fm = 'target_occs';
        let fb = {
            'source': demo_source,
            'target': target,
            'feedback': feedback,
            'fusion_method': fm,
            'rank': rank
        };
        // console.log(fb);
        $.post(gpl_endpoint_feedback, fb, null, 'json');
    }

    let $stimulusAutocomplete = $stimulusForm.find('.autocomplete').typeahead({
        'source': function (query, process) {
            reset();
            return $.get(
                '//en.wikipedia.org/w/api.php',
                {
                    'action': 'opensearch',
                    'format': 'json',
                    'redirects': 'resolve',
                    'origin': '*',
                    'search': query
                },
                function (data) {
                    let titles = data[1];
                    let descriptions = data[2];
                    let uris = data[3];
                    let items = [];
                    for (let i=0; i<titles.length; i++) {
                        items.push({
                            'title': titles[i],
                            'desc': descriptions[i],
                            'uri': uris[i]
                        });
                    }
                    return process(items);
                },
                'json'
            );
        },
        'items': 10,
        'matcher': function(x) {return true},
        'sorter': function(x) {return x},
        'displayText': function(item) {
            return `${item.title} <a href="${item.uri}">${item.uri}</a>`
        },
        'afterSelect': function(item) {
            let uri = item.uri;
            uri = uri.replace(/^https?:\/\/\w+\.wikipedia\.org\/wiki\//, 'http://dbpedia.org/resource/');
            this.$element.val(uri);
            this.$element.text(uri);
            $('#stimulusForm').find('button').click();
            // predict(uri);
            return uri;
        },
        'autoSelect': true
    });
    $stimulusAutocomplete.focus(function () {
        $(this).val('');
    });
    $stimulusForm.submit(function (event) {
        let source = $(this).find('.autocomplete').val();
        predict(source);
        event.preventDefault();
        return false;
    });
</script>

<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-81338887-1', 'auto');
    ga('send', 'pageview');
</script>

</body>

</html>
